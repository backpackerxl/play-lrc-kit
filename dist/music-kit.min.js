/**
 * @author: backpackerxl 2025/3/1
 * @description: 这是一个歌词渲染工具&音乐播放器控件控制工具
**/
const LrcOrLyrcKit=function(t,r){let n=[],o=[],a=null,i=null,s=0,l=!0,c=null,d=0,u=null,m=null,p=0,g=null,h=!1,f=[],v=0,b=`data-lrc-${Math.random().toString(36).substring(2,8)}`;function _(){a.querySelectorAll("br").forEach((t=>{t.remove()}));let t=i.lineWidth||300;o.forEach((t=>{t.span_arr.forEach((t=>{t.offsetWidth=t.span.offsetWidth}))}));for(let n of o){const o=n.target_node;n.span_arr.reduce(((n,a)=>{let i=n+a.offsetWidth;return i>t&&(o.insertBefore(r.createElement("br"),a.span),i=0),i}),0)}}function w(t){if(/^\{.*\}$/.test(t)){let r=JSON.parse(t);return`[00:${r.t/1e3}]${r.c[0].tx}${r.c[1].tx}`}return t}function y(t){if(/^\{.*\}$/.test(t)){let r=JSON.parse(t);return`[${r.t},0]${r.c[0].tx}${r.c[1].tx}`}return t}function L(t){let r,n=/\((\d+),(\d+),(\d+)\)([\u4e00-\u9fa5]+|[a-z|’|']+|[.,;:'"]+)/gi,o=[];for(;null!==(r=n.exec(t));){let t=[parseInt(r[1]),parseInt(r[2])],n=r[4];o.push([t,n])}return o}function E(t){let r=t.replace(/^\[/,"").replace(/\]$/,"").split(":");return parseFloat((60*r[0]+parseFloat(r[1])).toFixed(3))}function T(r){i=r,v=r.el.getBoundingClientRect().height/2,a=r.el,r.bindAudio&&function(r){if(!r.el)throw new Error("el不存在");if(!(r.el instanceof HTMLAudioElement))throw new Error("el不是一个html Audio播放器");let n;_audio=r.el,_audio.addEventListener("pause",(function(){cancelAnimationFrame(c),cancelAnimationFrame(g)})),_audio.addEventListener("play",(function(){if(_normal=!0,n&&clearTimeout(n),m&&p){const r=t.getComputedStyle(m).getPropertyValue("--progress");M(m,p-p*r/100,r)}C(),n=setTimeout((()=>{_normal=!1}),600)}))}({el:r.bindAudio}),r.bindPlacePlay&&function(t){let r=null,n=null,i=null,c=null,m=null;const p=t.pcTimer||1200,g=t.mbTimer||800,h=t.timeTagTimer||6e3;t.startMoveCallBack&&t.startMoveCallBack instanceof Function&&(r=t.startMoveCallBack.bind(t));t.onMoveCallBack&&t.onMoveCallBack instanceof Function&&(n=t.onMoveCallBack.bind(t));t.stopMoveCallBack&&t.stopMoveCallBack instanceof Function&&(i=t.stopMoveCallBack.bind(t));t.unMoveCallBack&&t.unMoveCallBack instanceof Function&&(m=t.unMoveCallBack.bind(t));t.clickCallBack&&t.clickCallBack instanceof Function&&(c=t.clickCallBack.bind(t));let f,v,b,_,w=null;t.getMusicTime=B;let y=t.startPlay;y&&y.addEventListener("click",(function(){u&&(u.target_node.classList.remove("now"),u.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")}))),_audio.currentTime=w.target_node.dataset.time,cancelAnimationFrame(_),m&&m(),c&&c(),d=a.scrollTop,l=!0}));const L=y.getBoundingClientRect(),E=L.top,T=L.bottom;function C(){let r,i;function c(){for(const t of o){const n=t.target_node.getBoundingClientRect();if(n.top>E&&n.bottom-n.height<T){r=t,i=n.height+s,b=a.scrollTop+n.top-E+n.height/2-i/2;break}}r&&r!==w&&(w=r,t.nowLine=r,t.targetRectHeight=i,n&&n()),_=requestAnimationFrame(c)}l=!1,_=requestAnimationFrame(c)}function M(){m&&m(),cancelAnimationFrame(_),l=!0,d=a.scrollTop,u&&P(100,u.target_node)}a.addEventListener("wheel",(()=>{r&&r(),C(),f&&clearTimeout(f),v&&clearTimeout(v),f=setTimeout((()=>{i&&i(),v=setTimeout(M,h),b&&k(a,b,60)}),p)}),{passive:!0});let $=0,F=0;a.addEventListener("touchstart",(e=>{$=e.touches[0].clientY}),{passive:!0}),a.addEventListener("touchmove",(e=>{F=Math.abs(e.touches[0].clientY-$)}),{passive:!0}),a.addEventListener("touchend",(()=>{F>0&&(r&&r(),C(),f&&clearTimeout(f),v&&clearTimeout(v),f=setTimeout((()=>{F=0,i&&i(),v=setTimeout(M,h),b&&k(a,b,60)}),g))}),{passive:!0})}(r.bindPlacePlay)}function C(){!function(t){let r=null;for(let n=0;n<o.length;n++){const a=o[n].target_node;if(n===o.length-1&&a.dataset.time<t){r=o[n];break}if(a.dataset.time<t&&o[n+1].target_node.dataset.time>t){r=o[n];break}}if(r&&u!==r){const t=r.span_arr;u&&(u.target_node.className="",u.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")}))),r.target_node.className="now",t.length<=0&&r.target_node.classList.add("color"),u=r,l&&P(300,u.target_node)}else if(r){const n=r.span_arr;n.length>0&&n.forEach((r=>{r.stm<=t&&0===r.span.classList.length&&(r.span.classList.add("now"),M(r.span,r.duration,100),m=r.span,p=r.duration)}))}}(_audio.currentTime),c=requestAnimationFrame(C)}function M(t,r,n){let o=null;0!==r?g=requestAnimationFrame((function a(i){o||(o=i);const s=i-o;let l=n*((r-s)/r);l=Math.max(l,0),t.style.setProperty("--progress",`${l}`),s<r&&l>0&&(g=requestAnimationFrame(a))})):t.style.setProperty("--progress","0")}function P(t,r){if(r.dataset.duration){f.forEach((t=>{t.cancel()}));let t=+r.dataset.duration-1.3;r.querySelectorAll("span").forEach(((r,n)=>{let o=r.animate([{opacity:0}],{easing:"ease",duration:80,fill:"forwards",delay:1e3*t-500*n});f.push(o)}))}const n=r.getBoundingClientRect();d+=n.top-v+n.height,k(a,d,t)}function k(t,r,n){const o=t.scrollTop,a=performance.now();requestAnimationFrame((function i(s){const l=s-a,c=Math.min(l/n,1);t.scrollTo(0,o+(r-o)*c),c<1&&requestAnimationFrame(i)}))}function B(t){if(Number.isNaN(t))return"00:00";let r=Math.floor(t/60),n=Math.floor(t%60);return r=r>=10?r:`0${r}`,n=n>=10?n:`0${n}`,`${r}:${n}`}function $(t){if(Number.isNaN(t))return;u&&(u.target_node.classList.remove("now"),u.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")})));let r=o.reduce(((r,n)=>Math.abs(n.time-t)<Math.abs(r.time-t)&&n.time<t?n:r));r.span_arr.forEach((r=>{r.stm<t&&r.span.classList.add("color")})),_audio.currentTime=t,r.target_node.classList.add("now"),P(350,r.target_node),u=r}return _audio=null,function(){const t=`.hide-tlyric p[${b}].tly_word{display:none;}p[${b}]{color:var(--baseColor);transition: all .2s;margin:var(--pMargin) 0;padding:0;font-size:var(--fontSize);text-align:var(--textAlign);line-height:var(--lineHeight)}p[${b}] span{padding-right:.5rem;}p[${b}].tly_word{margin:0 !important;font-size: var(--tlyricSize);line-height:var(--tlyricLineHeight)}p[${b}].color{color:var(--hilightColor);}p[${b}] span.circle{display: none;}p[${b}].now span.circle{display: inline-block;width: var(--circleSize);height: var(--circleSize);border-radius: 50%;background-color: var(--baseColor);margin: 0 .4rem;padding: 0 !important;animation: lrc-bounce 500ms infinite alternate;animation-delay: calc(var(--delay) * 1ms);}@keyframes lrc-bounce {to{opacity: .1;transform: translateY(-.5rem);}}`,n=`p[${b}] span.color{color:var(--hilightColor) !important}p[${b}] span.now {--progress:100;color: transparent;background-clip: text;-webkit-background-clip: text;background-image:linear-gradient(to left, var(--baseColor) calc(var(--progress) * 1%),var(--hilightColor)  0%);}`,o=r.createElement("style");o.textContent=t+n,r.documentElement.querySelector("head").appendChild(o)}(),{init(t){T(t)},translation(){a.classList.toggle("hide-tlyric")},toCurrentLyrc(t){$(t)},getMusicTime:t=>B(t),renderLrc(a){!function(a){o=[],n=[];const{el:l}=i,{lyric_data:c,tlyric_lyric:d,func:u,splitLetter:m}=a;if(!l||!c||!u)throw new Error("渲染视图的挂载点或歌词数据或歌词处理函数不能为空");if(h=m||!1,!(l instanceof Node))throw new Error("el不是一个元素节点");if(l.innerText="",!(u instanceof Function))throw new Error("func不是一个可执行函数");u(c,d);const p=r.createDocumentFragment();let g=n.length-1;n.forEach(((t,a)=>{let i={},s=[],l=t.current_time;const c=r.createElement("p");if(c.setAttribute(b,""),c.dataset.time=t.current_time,t.word_arr.length>0){let n=t.word_arr[t.word_arr.length-1];l=n[0][1]+n[0][2]/1e3;const o=r.createDocumentFragment();t.word_arr.forEach((t=>{const n=r.createElement("span");if(h){n.innerHTML=t[1].replace(/\S/g,"<b>$&</b>");let r=0,o=t[0][1];const a=n.querySelectorAll("b");if(a.length>0){o=Math.floor(o/a.length),a[0].style.setProperty("--delay","0ms"),a[0].style.setProperty("--duration",o+"ms");for(let t=1;t<a.length;t++)a[t].style.setProperty("--delay",`${r+=o}ms`),a[t].style.setProperty("--duration",o+"ms")}}else n.innerText=t[1];o.appendChild(n),s.push({span:n,stm:t[0][0]/1e3,duration:t[0][1]})})),c.appendChild(o)}else c.innerText=t.word;if(p.appendChild(c),t.tly_word){const n=r.createElement("p");n.setAttribute(b,""),n.innerText=t.tly_word,n.className="tly_word",i.tlyric_node=n,c.appendChild(n)}i.idx=a,i.target_node=c,i.span_arr=s,i.time=t.current_time,o.push(i);let d=n[Math.min(g,a+1)].current_time-l;if(d>6){const n=r.createElement("p");for(let t=0;t<3;t++){const o=r.createElement("span");o.classList.add("circle"),o.style.setProperty("--delay",180*t),n.appendChild(o)}n.dataset.time=t.current_time+1,n.dataset.duration=d,n.setAttribute(b,""),p.appendChild(n),o.push({target_node:n,span_arr:[],time:t.current_time+1})}})),l.appendChild(p),s=2*t.getComputedStyle(o[0].target_node).marginBottom.replace("px",""),_(),0!==_audio.currentTime&&$(_audio.currentTime)}(a)},addBr(){_()},showThumLryc(t,o,a,i){!function(t,o,a,i){if(Number.isNaN(t))return;let s=n.reduce(((r,n)=>Math.abs(n.current_time-t)<Math.abs(r.current_time-t)&&n.current_time<t?n:r)),l=s.idx,c=n.length-1,d=[];if(0===i)d.push({...s,flag:!0});else{let t=new Set,r=new Set;for(let o=0;o<i;o++)l>0&&t.add(n[Math.max(l-i+o,0)]),l>0&&l!==c&&r.add(n[Math.min(l+o+1,c)]);d=[...t,{...s,flag:!0},...r]}const u=r.createDocumentFragment();d.forEach((t=>{const n=r.createElement("p");if(n.innerText=t.word,t.tly_word){const o=r.createElement("p");o.innerText=t.tly_word,o.className="tly_word",n.appendChild(o)}t.flag&&n.classList.add(a),u.appendChild(n)})),o.innerHTML="",o.appendChild(u)}(t,o,a,i)},doLrcLyric:function(t,r){let o=t.split("\n"),a=[];r&&(a=r.split("\n"));const i=/\[.+?\]/;o=o.map((t=>{const r=(t=w(t)).match(i);return r?{current_time:E(r[0]),word:t.replace(i,"").trim(),word_arr:[]}:null})).filter((t=>null!==t));const s=new Map;a.forEach((t=>{const r=(t=w(t)).match(i);return r&&s.set(E(r[0]),t.replace(i,"").trim()),null})),o.forEach(((t,r)=>{""!==t.word&&n.push({...t,tly_word:s.get(t.current_time)||null,idx:r})}))},doYrcLyric:function(t,r){let o=t.split("\n"),a=[];r&&(a=r.split("\n"));const i=/\[.+?\]/;o=o.map((t=>{const r=(t=y(t)).match(i);if(r){return{current_time:r[0].replace(/^\[/,"").replace(/\]$/,"").split(",")[0]/1e3,word:t.replace(i,"").replaceAll(/\(.+?\)/g,"").trim(),word_arr:L(t)}}return null})).filter((t=>null!==t));const s=new Map;a.forEach((t=>{const r=(t=y(t)).match(i);return r&&s.set(E(r[0]),t.replace(i,"").trim()),null})),o.forEach(((t,r)=>{n.push({...t,tly_word:s.get(t.current_time)||null,idx:r})}))}}}(window,document),MusicBarControl=function(t,r){let n=null,o=0,a=0,i=`data-bar-${Math.random().toString(36).substring(2,8)}`;function s(o){if(!o.oProgress)throw new Error("oProgress:总滑动条不存在");if(!(o.oProgress instanceof Node))throw new Error("oProgress:总滑动条不是一个dom节点");if(!(o.progressBarCallBack instanceof Function))throw new Error(`progressBarCallBack: ${o.progressBarCallBack}不是个函数`);o._bound=o.oProgress.getBoundingClientRect();const a=r.createElement("div"),s=r.createElement("div"),p=r.createElement("div"),g=r.createElement("div");a.classList.add("progress-under"),a.setAttribute(i,""),s.classList.add("progress-mid"),s.setAttribute(i,""),p.classList.add("progress-top"),p.setAttribute(i,""),g.classList.add("slider"),g.setAttribute(i,""),p.appendChild(g),o.oProgress.setAttribute(i,""),o.oProgress.appendChild(a),o.oProgress.appendChild(s),o.oProgress.appendChild(p),o.initWidth&&(p.style.width=o.initWidth),o._moveing=!1,o.oSlider=g,o.oProgressUnder=a,o.oProgressMid=s,o.oProgressTop=p,(o.el instanceof HTMLAudioElement||o.el instanceof HTMLVideoElement)&&(o.el.addEventListener("loadedmetadata",(function(){o.oTotal.innerText=LrcOrLyrcKit.getMusicTime(o.el.duration),o.oProgressTop.style.width="0%",o.progressBarCallBack&&o.progressBarCallBack(0)})),o._loadBarPlusFunc=l.bind(t,o),o.el.addEventListener("timeupdate",o._loadBarPlusFunc),o.el.addEventListener("progress",(function(){if(o.el.buffered.length>0){const t=o.el.buffered.end(o.el.buffered.length-1)/o.el.duration*100;o.oProgressMid&&(o.oProgressMid.style.width=`${t}%`)}}))),function(o){o._clickProgressFunc=m.bind(t,o),o.oProgress.addEventListener("click",o._clickProgressFunc),o.oSlider.addEventListener("mousedown",d.bind(t,o)),r.addEventListener("mousemove",(function(e){o._moveing&&(n=requestAnimationFrame(c.bind(t,o,e)))})),r.addEventListener("mouseup",u.bind(t,o)),o.oSlider.addEventListener("touchstart",d.bind(t,o),{passive:!0}),r.addEventListener("touchmove",(function(e){o._moveing&&(n=requestAnimationFrame(c.bind(t,o,e.touches[0])))}),{passive:!0}),r.addEventListener("touchend",u.bind(t,o),{passive:!0})}(o)}function l(t){o=t.el.currentTime;const r=t.el.currentTime/t.el.duration*100;t.oProgressTop.style.width=`${r}%`,t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(t.el.currentTime)),t.progressBarCallBack&&t.progressBarCallBack((o/t.el.duration).toFixed(4))}function c(t,e){a=e.clientX-t._bound.left,a<0?a=0:a>t._bound.width&&(a=t._bound.width),t.oProgressTop.style.width=a+"px",t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(o=t.el.duration*(a/t._bound.width),t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(o)),t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&LrcOrLyrcKit.showThumLryc(o,t.oShowLyrc,"highlight",2)}function d(t){t._moveing=!0,_showLyrc&&clearTimeout(_showLyrc),t.oProgressUnder.classList.add("scale"),t.oSlider.classList.add("dragging"),t.oProgress.classList.add("dragging"),t.oProgressMid&&t.oProgressMid.classList.add("scale"),t.oProgressTop.classList.add("scale"),t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&t.el.removeEventListener("timeupdate",t._loadBarPlusFunc),t.oProgress.removeEventListener("click",t._clickProgressFunc),t.oSlider.style.transform="translateY(.1rem) scale(2)",t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.add("show")}function u(t){!Number.isNaN(o)&&t._moveing&&(t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(LrcOrLyrcKit.toCurrentLyrc(o),t.el.addEventListener("timeupdate",t._loadBarPlusFunc)),!t.vibrate||0!==a&&a!==t._bound.width||navigator.vibrate&&navigator.vibrate(t.vibrate),t.progressBarCallBack&&t.progressBarCallBack((a/t._bound.width).toFixed(4))),t.oSlider.classList.remove("dragging"),t.oProgress.classList.remove("dragging"),_showLyrc=setTimeout((function(){t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.remove("show"),t.oSlider.style="",t.oProgressUnder.classList.remove("scale"),t.oProgressMid&&t.oProgressMid.classList.remove("scale"),t.oProgressTop.classList.remove("scale"),t.oProgress.addEventListener("click",t._clickProgressFunc),cancelAnimationFrame(n)}),1e3),t._moveing=!1}function m(r,e){c.call(t,r,e),r.vibrate&&navigator.vibrate&&navigator.vibrate(r.vibrate),r.el&&(r.el instanceof HTMLAudioElement||r.el instanceof HTMLVideoElement)&&LrcOrLyrcKit.toCurrentLyrc(o),r.progressBarCallBack&&r.progressBarCallBack((a/r._bound.width).toFixed(4))}return _showLyrc=0,function(){let t=`.progress-under[${i}],.progress-mid[${i}],.progress-top[${i}]{height:var(--bar-height);border-radius:calc(var(--bar-height) / 2);position:absolute;top:0;left:0;transform:translateY(calc(var(--pg-height) / 2));transition:all .3s}.progress-under.scale[${i}],.progress-mid.scale[${i}],.progress-top.scale[${i}]{height:calc(var(--bar-height) + .2rem);border-radius:calc(var(--bar-height) / 2 + .1rem)}.progress-under[${i}]{width:inherit;background-color:var(--bar-under-bg)}.progress-mid[${i}]{width:0%;background-color:var(--bar-mid-bg)}.progress-top[${i}]{width:0%;background-color:var(--bar-top-bg)}.slider[${i}]{width:var(--slider-size);height:var(--slider-size);border-radius:calc(var(--slider-size) / 2);background-color:var(--slider-bg);position:absolute;right:calc(var(--slider-size) / -2);top:calc(var(--slider-size) / -4);transition:all .3s}.slider[${i}].dragging{cursor:grabbing !important}.progress[${i}].dragging{cursor:grabbing !important}.progress-top[${i}].scale .slider[${i}],.slider[${i}]:hover{transform:scale(1.3);cursor:grab}`;const n=r.createElement("style");n.textContent=t,r.documentElement.querySelector("head").appendChild(n)}(),{init(t){s(t)}}}(window,document);