/**
 * @author: backpackerxl 2025/3/1
 * @description: This is a lyrc render kit & Music player control kit
**/
const LrcOrLyrcKit=function(t,r){let n=[],o=[],a=null,i=null,s=0,l=!0,c=null,d=0,u=null,g=null,p=0,m=null,h=!1,f=[],b=0,v=`data-lrc-${Math.random().toString(36).substring(2,8)}`;function y(){a.querySelectorAll("br").forEach((t=>{t.remove()}));let t=i.lineWidth||300;o.forEach((t=>{t.span_arr.forEach((t=>{t.offsetWidth=t.span.offsetWidth}))}));for(let n of o){const o=n.target_node;n.span_arr.reduce(((n,a)=>{let i=n+a.offsetWidth;return i>t&&(o.insertBefore(r.createElement("br"),a.span),i=0),i}),0)}}function w(t){if(/^\{.*\}$/.test(t)){let r=JSON.parse(t);return`[00:${r.t/1e3}]${r.c[0].tx}${r.c[1].tx}`}return t}function _(t){if(/^\{.*\}$/.test(t)){let r=JSON.parse(t);return`[${r.t},0]${r.c[0].tx}${r.c[1].tx}`}return t}function L(t){let r,n=/\((\d+),(\d+),(\d+)\)([\u4e00-\u9fa5]+|[a-z|â€™|']+|[.,;:'"]+)/gi,o=[];for(;null!==(r=n.exec(t));){let t=[parseInt(r[1]),parseInt(r[2])],n=r[4];o.push([t,n])}return o}function T(t){let r=t.replace(/^\[/,"").replace(/\]$/,"").split(":");return parseFloat((60*r[0]+parseFloat(r[1])).toFixed(3))}function E(r){i=r,b=r.el.getBoundingClientRect().height/2,a=r.el,r.bindAudio?function(r){if(!r.el)throw new Error("Not find el properties.");if(!(r.el instanceof HTMLAudioElement))throw new Error("el not a HTML Audio player.");let n;_audio=r.el,_audio.addEventListener("pause",(function(){cancelAnimationFrame(c),cancelAnimationFrame(m)})),_audio.addEventListener("play",(function(){if(_normal=!0,n&&clearTimeout(n),g&&p){const r=t.getComputedStyle(g).getPropertyValue("--progress");k(g,p-p*r/100,r)}M(),n=setTimeout((()=>{_normal=!1}),600)}))}({el:r.bindAudio}):console.warn("No setting audio control, so it is impossible to achieve lyrics scrolling and highlighting along with the song."),r.bindPlacePlay?function(t){let r=null,n=null,i=null,c=null,g=null;const p=t.pcTimer||1200,m=t.mbTimer||800,h=t.timeTagTimer||6e3;t.startMoveCallBack&&t.startMoveCallBack instanceof Function?r=t.startMoveCallBack.bind(t):console.warn("The callback function for starting the scrolling of the set lyrics has failed, and the reference object for clicking to play cannot be displayed during the scrolling of the lyrics.");t.onMoveCallBack&&t.onMoveCallBack instanceof Function?n=t.onMoveCallBack.bind(t):console.warn("The callback function executed during the set lyrics scrolling has failed, and real-time linkage between scrolling lyrics and clicking on reference objects cannot be achieved.");t.stopMoveCallBack&&t.stopMoveCallBack instanceof Function?i=t.stopMoveCallBack.bind(t):console.warn("The callback function executed after the set lyrics scroll ends failed, and there will be no operation after the scroll ends.");t.unMoveCallBack&&t.unMoveCallBack instanceof Function?g=t.unMoveCallBack.bind(t):console.warn("The callback function executed after the set lyrics scroll is completed fails, and the scrolling reference will not be released.");t.clickCallBack&&t.clickCallBack instanceof Function&&(c=t.clickCallBack.bind(t));let f,b,v,y,w=null;t.getMusicTime=B;let _=t.startPlay;_&&_.addEventListener("click",(function(){u&&(u.target_node.classList.remove("now"),u.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")}))),_audio.currentTime=w.target_node.dataset.time,cancelAnimationFrame(y),g&&g(),c&&c(),d=a.scrollTop,l=!0}));const L=_.getBoundingClientRect(),T=L.top,E=L.bottom;function M(){let r,i;function c(){for(let t=0;t<=o.length;t++){let n=o[t];if(n){n.target_node.dataset.duration&&(n=o[Math.min(o.length-1,t+1)]);const l=n.target_node.getBoundingClientRect();if(l.top>T&&l.bottom-l.height<E){r=n,i=l.height+s,v=a.scrollTop+l.top-T+l.height/2-i/2;break}}}r&&r!==w&&(w=r,t.nowLine=r,t.targetRectHeight=i,n&&n()),y=requestAnimationFrame(c)}l=!1,y=requestAnimationFrame(c)}function k(){g&&g(),cancelAnimationFrame(y),l=!0,d=a.scrollTop,u&&C(100,u.target_node)}a.addEventListener("wheel",(()=>{r&&r(),M(),f&&clearTimeout(f),b&&clearTimeout(b),f=setTimeout((()=>{i&&i(),b=setTimeout(k,h),v&&P(a,v,60)}),p)}),{passive:!0});let $=0,F=0;a.addEventListener("touchstart",(e=>{$=e.touches[0].clientY}),{passive:!0}),a.addEventListener("touchmove",(e=>{F=Math.abs(e.touches[0].clientY-$)}),{passive:!0}),a.addEventListener("touchend",(()=>{F>0&&(r&&r(),M(),f&&clearTimeout(f),b&&clearTimeout(b),f=setTimeout((()=>{F=0,i&&i(),b=setTimeout(k,h),v&&P(a,v,60)}),m))}),{passive:!0})}(r.bindPlacePlay):console.warn("If the click to play configuration is not set, the function of scrolling to the specified lyrics and clicking to play cannot be achieved.")}function M(){!function(t){let r=null;for(let n=0;n<o.length;n++){const a=o[n].target_node;if(n===o.length-1&&a.dataset.time<t){r=o[n];break}if(a.dataset.time<t&&o[n+1].target_node.dataset.time>t){r=o[n];break}}if(r&&u!==r){const t=r.span_arr;u&&(u.target_node.className="",u.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")}))),r.target_node.className="now",t.length<=0&&r.target_node.classList.add("color"),u=r,l&&C(300,u.target_node)}else if(r){const n=r.span_arr;n.length>0&&n.forEach((r=>{r.stm<=t&&0===r.span.classList.length&&(r.span.classList.add("now"),k(r.span,r.duration,100),g=r.span,p=r.duration)}))}}(_audio.currentTime),c=requestAnimationFrame(M)}function k(t,r,n){let o=null;0!==r?m=requestAnimationFrame((function a(i){o||(o=i);const s=i-o;let l=n*((r-s)/r);l=Math.max(l,0),t.style.setProperty("--progress",`${l}`),s<r&&l>0&&(m=requestAnimationFrame(a))})):t.style.setProperty("--progress","0")}function C(t,r){if(r.dataset.duration){f.forEach((t=>{t.cancel()}));let t=+r.dataset.duration-1.3;r.querySelectorAll("span").forEach(((r,n)=>{let o=r.animate([{opacity:0}],{easing:"ease",duration:80,fill:"forwards",delay:1e3*t-500*n});f.push(o)}))}const n=r.getBoundingClientRect();d+=n.top-b+n.height,P(a,d,t)}function P(t,r,n){const o=t.scrollTop,a=performance.now();requestAnimationFrame((function i(s){const l=s-a,c=Math.min(l/n,1);t.scrollTo(0,o+(r-o)*c),c<1&&requestAnimationFrame(i)}))}function B(t){if(Number.isNaN(t))return"00:00";let r=Math.floor(t/60),n=Math.floor(t%60);return r=r>=10?r:`0${r}`,n=n>=10?n:`0${n}`,`${r}:${n}`}function $(t){if(Number.isNaN(t))return;u&&(u.target_node.classList.remove("now"),u.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")})));let r=o.reduce(((r,n)=>Math.abs(n.time-t)<Math.abs(r.time-t)&&n.time<t?n:r));r.span_arr.forEach((r=>{r.stm<t&&r.span.classList.add("color")})),_audio.currentTime=t,r.target_node.classList.add("now"),C(350,r.target_node),u=r}return _audio=null,function(){const t=`.hide-tlyric p[${v}].tly_word{display:none;}p[${v}]{color:var(--baseColor);transition: all .2s;margin:var(--pMargin) 0;padding:0;font-size:var(--fontSize);text-align:var(--textAlign);line-height:var(--lineHeight)}p[${v}] span{padding-right:.5rem;}p[${v}].tly_word{margin:0 !important;font-size: var(--tlyricSize);line-height:var(--tlyricLineHeight)}p[${v}].color{color:var(--hilightColor);}p[${v}] span.circle{display: none;}p[${v}].now span.circle{display: inline-block;width: var(--circleSize);height: var(--circleSize);border-radius: 50%;background-color: var(--baseColor);margin: 0 .4rem;padding: 0 !important;animation: lrc-bounce 500ms infinite alternate;animation-delay: calc(var(--delay) * 1ms);}@keyframes lrc-bounce {to{opacity: .1;transform: translateY(-.5rem) scale(1.2);}}`,n=`p[${v}] span.color{color:var(--hilightColor) !important}p[${v}] span.now {--progress:100;color: transparent;background-clip: text;-webkit-background-clip: text;background-image:linear-gradient(to left, var(--baseColor) calc(var(--progress) * 1%),var(--hilightColor)  0%);}`,o=r.createElement("style");o.textContent=t+n,r.documentElement.querySelector("head").appendChild(o)}(),{init(t){E(t)},translation(){a.classList.toggle("hide-tlyric")},toCurrentLyrc(t){$(t)},getMusicTime:t=>B(t),renderLrc(a){!function(a){o=[],n=[];const{el:l}=i,{lyric_data:c,tlyric_lyric:d,func:u,splitLetter:g}=a;if(!l||!c||!u)throw new Error("The mount el or lyric data or lyric processing func for rendering views cannot be empty.");if(h=g||!1,!(l instanceof Node))throw new Error("el not an element node.");if(l.innerText="",!(u instanceof Function))throw new Error("func not a function.");u(c,d);const p=r.createDocumentFragment();let m=n.length-1;n.forEach(((t,a)=>{let i={},s=[],l=t.current_time;const c=r.createElement("p");if(c.setAttribute(v,""),c.dataset.time=t.current_time,t.word_arr.length>0){let n=t.word_arr[t.word_arr.length-1];l=(n[0][0]+n[0][1])/1e3;const o=r.createDocumentFragment();t.word_arr.forEach((t=>{const n=r.createElement("span");if(h){n.innerHTML=t[1].replace(/\S/g,"<b>$&</b>");let r=0,o=t[0][1];const a=n.querySelectorAll("b");if(a.length>0){o=Math.floor(o/a.length),a[0].style.setProperty("--delay","0ms"),a[0].style.setProperty("--duration",o+"ms");for(let t=1;t<a.length;t++)a[t].style.setProperty("--delay",`${r+=o}ms`),a[t].style.setProperty("--duration",o+"ms")}}else n.innerText=t[1];o.appendChild(n),s.push({span:n,stm:t[0][0]/1e3,duration:t[0][1]})})),c.appendChild(o)}else c.innerText=t.word;if(p.appendChild(c),t.tly_word){const n=r.createElement("p");n.setAttribute(v,""),n.innerText=t.tly_word,n.className="tly_word",i.tlyric_node=n,c.appendChild(n)}i.idx=a,i.target_node=c,i.span_arr=s,i.time=t.current_time,o.push(i);let d=n[Math.min(m,a+1)].current_time-l;if(d>6){const n=r.createElement("p");for(let t=0;t<3;t++){const o=r.createElement("span");o.classList.add("circle"),o.style.setProperty("--delay",180*t),n.appendChild(o)}n.dataset.time=l+1,n.dataset.duration=d.toFixed(2),n.setAttribute(v,""),p.appendChild(n),o.push({target_node:n,span_arr:[],time:t.current_time+1})}})),l.appendChild(p),s=2*t.getComputedStyle(o[0].target_node).marginBottom.replace("px",""),y(),0!==_audio.currentTime&&$(_audio.currentTime)}(a)},addBr(){y()},showThumLryc(t,o,a,i){!function(t,o,a,i){if(Number.isNaN(t))return;let s=n.reduce(((r,n)=>Math.abs(n.current_time-t)<Math.abs(r.current_time-t)&&n.current_time<t?n:r)),l=s.idx,c=n.length-1,d=[];if(0===i)d.push({...s,flag:!0});else{let t=new Set,r=new Set;for(let o=0;o<i;o++)l>0&&t.add(n[Math.max(l-i+o,0)]),l>0&&l!==c&&r.add(n[Math.min(l+o+1,c)]);d=[...t,{...s,flag:!0},...r]}const u=r.createDocumentFragment();d.forEach((t=>{const n=r.createElement("p");if(n.innerText=t.word,t.tly_word){const o=r.createElement("p");o.innerText=t.tly_word,o.className="tly_word",n.appendChild(o)}t.flag&&n.classList.add(a),u.appendChild(n)})),o.innerHTML="",o.appendChild(u)}(t,o,a,i)},doLrcLyric:function(t,r){let o=t.split("\n"),a=[];r&&(a=r.split("\n"));const i=/\[.+?\]/;o=o.map((t=>{const r=(t=w(t)).match(i);return r?{current_time:T(r[0]),word:t.replace(i,"").trim(),word_arr:[]}:null})).filter((t=>null!==t));const s=new Map;a.forEach((t=>{const r=(t=w(t)).match(i);return r&&s.set(T(r[0]),t.replace(i,"").trim()),null})),o.forEach(((t,r)=>{""!==t.word&&n.push({...t,tly_word:s.get(t.current_time)||null,idx:r})}))},doYrcLyric:function(t,r){let o=t.split("\n"),a=[];r&&(a=r.split("\n"));const i=/\[.+?\]/;o=o.map((t=>{const r=(t=_(t)).match(i);if(r){return{current_time:r[0].replace(/^\[/,"").replace(/\]$/,"").split(",")[0]/1e3,word:t.replace(i,"").replaceAll(/\(.+?\)/g,"").trim(),word_arr:L(t)}}return null})).filter((t=>null!==t));const s=new Map;a.forEach((t=>{const r=(t=_(t)).match(i);return r&&s.set(T(r[0]),t.replace(i,"").trim()),null})),o.forEach(((t,r)=>{n.push({...t,tly_word:s.get(t.current_time)||null,idx:r})}))}}}(window,document),MusicBarControl=function(t,r){let n=null,o=0,a=0,i=`data-bar-${Math.random().toString(36).substring(2,8)}`;function s(o){if(!o.oProgress)throw new Error("Not find oProgress properties");if(!(o.oProgress instanceof Node))throw new Error(`${o.oProgress} not a HTML node`);if(!(o.progressBarCallBack instanceof Function))throw new Error(`${o.progressBarCallBack} not a function.`);o._bound=o.oProgress.getBoundingClientRect();const a=r.createElement("div"),s=r.createElement("div"),p=r.createElement("div"),m=r.createElement("div");a.classList.add("progress-under"),a.setAttribute(i,""),s.classList.add("progress-mid"),s.setAttribute(i,""),p.classList.add("progress-top"),p.setAttribute(i,""),m.classList.add("slider"),m.setAttribute(i,""),p.appendChild(m),o.oProgress.setAttribute(i,""),o.oProgress.appendChild(a),o.oProgress.appendChild(s),o.oProgress.appendChild(p),o.initWidth&&(p.style.width=o.initWidth),o._moveing=!1,o.oSlider=m,o.oProgressUnder=a,o.oProgressMid=s,o.oProgressTop=p,(o.el instanceof HTMLAudioElement||o.el instanceof HTMLVideoElement)&&(o.el.addEventListener("loadedmetadata",(function(){o.oTotal.innerText=LrcOrLyrcKit.getMusicTime(o.el.duration),o.oProgressTop.style.width="0%",o.progressBarCallBack&&o.progressBarCallBack(0)})),o._loadBarPlusFunc=l.bind(t,o),o.el.addEventListener("timeupdate",o._loadBarPlusFunc),o.el.addEventListener("progress",(function(){if(o.el.buffered.length>0){const t=o.el.buffered.end(o.el.buffered.length-1)/o.el.duration*100;o.oProgressMid&&(o.oProgressMid.style.width=`${t}%`)}}))),function(o){o._clickProgressFunc=g.bind(t,o),o.oProgress.addEventListener("click",o._clickProgressFunc),o.oSlider.addEventListener("mousedown",d.bind(t,o)),r.addEventListener("mousemove",(function(e){o._moveing&&(n=requestAnimationFrame(c.bind(t,o,e)))})),r.addEventListener("mouseup",u.bind(t,o)),o.oSlider.addEventListener("touchstart",d.bind(t,o),{passive:!0}),r.addEventListener("touchmove",(function(e){o._moveing&&(n=requestAnimationFrame(c.bind(t,o,e.touches[0])))}),{passive:!0}),r.addEventListener("touchend",u.bind(t,o),{passive:!0})}(o)}function l(t){o=t.el.currentTime;const r=t.el.currentTime/t.el.duration*100;t.oProgressTop.style.width=`${r}%`,t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(t.el.currentTime)),t.progressBarCallBack&&t.progressBarCallBack((o/t.el.duration).toFixed(4))}function c(t,e){a=e.clientX-t._bound.left,a<0?a=0:a>t._bound.width&&(a=t._bound.width),t.oProgressTop.style.width=a+"px",t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(o=t.el.duration*(a/t._bound.width),t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(o)),t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&LrcOrLyrcKit.showThumLryc(o,t.oShowLyrc,"highlight",2)}function d(t){t._moveing=!0,_showLyrc&&clearTimeout(_showLyrc),t.oProgressUnder.classList.add("scale"),t.oSlider.classList.add("dragging"),t.oProgress.classList.add("dragging"),t.oProgressMid&&t.oProgressMid.classList.add("scale"),t.oProgressTop.classList.add("scale"),t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&t.el.removeEventListener("timeupdate",t._loadBarPlusFunc),t.oProgress.removeEventListener("click",t._clickProgressFunc),t.oSlider.style.transform="translateY(.1rem) scale(2)",t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.add("show")}function u(t){!Number.isNaN(o)&&t._moveing&&(t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(LrcOrLyrcKit.toCurrentLyrc(o),t.el.addEventListener("timeupdate",t._loadBarPlusFunc)),!t.vibrate||0!==a&&a!==t._bound.width||navigator.vibrate&&navigator.vibrate(t.vibrate),t.progressBarCallBack&&t.progressBarCallBack((a/t._bound.width).toFixed(4))),t.oSlider.classList.remove("dragging"),t.oProgress.classList.remove("dragging"),_showLyrc=setTimeout((function(){t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.remove("show"),t.oSlider.style="",t.oProgressUnder.classList.remove("scale"),t.oProgressMid&&t.oProgressMid.classList.remove("scale"),t.oProgressTop.classList.remove("scale"),t.oProgress.addEventListener("click",t._clickProgressFunc),cancelAnimationFrame(n)}),1e3),t._moveing=!1}function g(r,e){c.call(t,r,e),r.vibrate&&navigator.vibrate&&navigator.vibrate(r.vibrate),r.el&&(r.el instanceof HTMLAudioElement||r.el instanceof HTMLVideoElement)&&LrcOrLyrcKit.toCurrentLyrc(o),r.progressBarCallBack&&r.progressBarCallBack((a/r._bound.width).toFixed(4))}return _showLyrc=0,function(){let t=`.progress-under[${i}],.progress-mid[${i}],.progress-top[${i}]{height:var(--bar-height);border-radius:calc(var(--bar-height) / 2);position:absolute;top:0;left:0;transform:translateY(calc(var(--pg-height) / 2));transition:all .3s}.progress-under.scale[${i}],.progress-mid.scale[${i}],.progress-top.scale[${i}]{height:calc(var(--bar-height) + .2rem);border-radius:calc(var(--bar-height) / 2 + .1rem)}.progress-under[${i}]{width:inherit;background-color:var(--bar-under-bg)}.progress-mid[${i}]{width:0%;background-color:var(--bar-mid-bg)}.progress-top[${i}]{width:0%;background-color:var(--bar-top-bg)}.slider[${i}]{width:var(--slider-size);height:var(--slider-size);border-radius:calc(var(--slider-size) / 2);background-color:var(--slider-bg);position:absolute;right:calc(var(--slider-size) / -2);top:calc(var(--slider-size) / -4);transition:all .3s}.slider[${i}].dragging{cursor:grabbing !important}.progress[${i}].dragging{cursor:grabbing !important}.progress-top[${i}].scale .slider[${i}],.slider[${i}]:hover{transform:scale(1.3);cursor:grab}`;const n=r.createElement("style");n.textContent=t,r.documentElement.querySelector("head").appendChild(n)}(),{init(t){s(t)}}}(window,document);