/**
 * @author: backpackerxl 2025/3/4
 * @description: This is a lyrc render kit & Music player control kit
**/
const LrcOrLyrcKit=function(t,r){let n=[],o=[],a=null,i=null,s=!0,l=null,c=null,d=null,u=0,g=null,m=!1,p=[],h=[],f=0,b=!1,v=`data-lrc-${Math.random().toString(36).substring(2,8)}`,y=null;function w(){a.querySelectorAll("br").forEach((t=>{t.remove()}));let t=i.lineWidth||300;o.forEach((t=>{t.span_arr.forEach((t=>{t.offsetWidth=t.span.offsetWidth}))}));for(let n of o){const o=n.target_node;n.span_arr.reduce(((n,a)=>{let i=n+a.offsetWidth;return i>t&&(o.insertBefore(r.createElement("br"),a.span),i=0),i}),0)}}function L(t){if(/^\{.*\}$/.test(t)){let r=JSON.parse(t);return`[00:${r.t/1e3}]${r.c[0].tx}${r.c[1].tx}`}return t}function _(t,r){let o=t.split("\n"),a=[];r&&(a=r.split("\n"));const i=/\[.+?\]/;o=o.map((t=>{const r=(t=L(t)).match(i);return r?{current_time:k(r[0]),word:t.replace(i,"").trim(),word_arr:[]}:null})).filter((t=>null!==t));const s=new Map;a.forEach((t=>{const r=(t=L(t)).match(i);return r&&s.set(k(r[0]),t.replace(i,"").trim()),null})),o.forEach(((t,r)=>{""!==t.word&&n.push({...t,tly_word:s.get(t.current_time)||null,idx:r})}))}function E(t,r){let o=t.split("\n"),a=[];r&&(a=r.split("\n"));const i=/\[.+?\]/;o=o.map((t=>{const r=(t=T(t)).match(i);if(r){return{current_time:r[0].replace(/^\[/,"").replace(/\]$/,"").split(",")[0]/1e3,word:t.replace(i,"").replaceAll(/\(.+?\)/g,"").trim(),word_arr:M(t)}}return null})).filter((t=>null!==t));const s=new Map;a.forEach((t=>{const r=(t=T(t)).match(i);return r&&s.set(k(r[0]),t.replace(i,"").trim()),null})),o.forEach(((t,r)=>{n.push({...t,tly_word:s.get(t.current_time)||null,idx:r})}))}function T(t){if(/^\{.*\}$/.test(t)){let r=JSON.parse(t);return`[${r.t},0]${r.c[0].tx}${r.c[1].tx}`}return t}function M(t){let r,n=/\((\d+),(\d+),(\d+)\)([\u4e00-\u9fa5]+|[a-z|â€™|']+|[.,;:'"]+)/gi,o=[];for(;null!==(r=n.exec(t));){let t=[parseInt(r[1]),parseInt(r[2])],n=r[4];o.push([t,n])}return o}function k(t){let r=t.replace(/^\[/,"").replace(/\]$/,"").split(":");return parseFloat((60*r[0]+parseFloat(r[1])).toFixed(3))}function C(r){i=r,f=r.el.getBoundingClientRect().height/2,a=r.el,r.lyricJump&&(b=r.lyricJump),r.bindAudio?function(r){if(!r.el)throw new Error("Not find el properties.");if(!(r.el instanceof HTMLAudioElement))throw new Error("el not a HTML Audio player.");let n;y=r.el,y.addEventListener("pause",(function(){cancelAnimationFrame(l),cancelAnimationFrame(g)})),y.addEventListener("play",(function(){if(_normal=!0,n&&clearTimeout(n),d&&u){const r=t.getComputedStyle(d).getPropertyValue("--progress");$(d,u-u*r/100,r)}P(),n=setTimeout((()=>{_normal=!1}),600)}))}({el:r.bindAudio}):console.warn("No setting audio control, so it is impossible to achieve lyrics scrolling and highlighting along with the song."),r.bindPlacePlay?function(r){let n=null,i=null,l=null,d=null,u=null,g=null,m=0,p=!1;const f=r.pcTimer||1200,v=r.mbTimer||800,w=r.timeTagTimer||6e3;r.startMoveCallBack&&r.startMoveCallBack instanceof Function?n=r.startMoveCallBack.bind(r):console.warn("The callback function for starting the scrolling of the set lyrics has failed, and the reference object for clicking to play cannot be displayed during the scrolling of the lyrics.");r.onMoveCallBack&&r.onMoveCallBack instanceof Function?i=r.onMoveCallBack.bind(r):console.warn("The callback function executed during the set lyrics scrolling has failed, and real-time linkage between scrolling lyrics and clicking on reference objects cannot be achieved.");r.stopMoveCallBack&&r.stopMoveCallBack instanceof Function?l=r.stopMoveCallBack.bind(r):console.warn("The callback function executed after the set lyrics scroll ends failed, and there will be no operation after the scroll ends.");r.unMoveCallBack&&r.unMoveCallBack instanceof Function?u=r.unMoveCallBack.bind(r):console.warn("The callback function executed after the set lyrics scroll is completed fails, and the scrolling reference will not be released.");r.clickCallBack&&r.clickCallBack instanceof Function&&(d=r.clickCallBack.bind(r));let L,_,E,T=null;r.getMusicTime=F;let M=r.startPlay;M&&M.addEventListener("click",(function(){c&&(c.target_node.classList.remove("now"),c.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")}))),y.currentTime=T.target_node.dataset.time,p=!1,cancelAnimationFrame(g),u&&u(),d&&d(),s=!0}));const k=M.getBoundingClientRect(),C=k.top,P=k.bottom;function $(){let n,l;function c(){for(let t=0;t<=o.length;t++){let r=o[t];if(r){r.target_node.dataset.duration&&(r=o[Math.min(o.length-1,t+1)]);const i=r.target_node.getBoundingClientRect();if(i.top>C&&i.bottom-i.height<P){n=r,l=i.height+m,E=a.scrollTop+i.top-C+i.height/2-l/2;break}}}n&&n!==T&&(T=n,r.nowLine=n,r.targetRectHeight=l,i&&i()),p&&(g=requestAnimationFrame(c))}s=!1,h.forEach((t=>{t.cancel()})),o.length>0&&(m=2*t.getComputedStyle(o[0].target_node).marginBottom.replace("px","")),g=requestAnimationFrame(c)}function x(){if(u&&u(),s=!0,c){let t=b;b=!1,B(200,c.target_node),t&&(b=!0)}}a.addEventListener("wheel",(()=>{n&&n(),p=!0,$(),L&&clearTimeout(L),_&&clearTimeout(_),L=setTimeout((()=>{l&&l(),p=!1,cancelAnimationFrame(g),_=setTimeout(x,w),E&&A(a,E,60)}),f)}),{passive:!0});let S=0,N=0;a.addEventListener("touchstart",(e=>{L&&clearTimeout(L),_&&clearTimeout(_),n&&n(),p=!0,S=e.touches[0].clientY}),{passive:!0}),a.addEventListener("touchmove",(e=>{$(),N=Math.abs(e.touches[0].clientY-S)}),{passive:!0}),a.addEventListener("touchend",(()=>{N>0&&(L=setTimeout((()=>{N=0,l&&l(),p=!1,cancelAnimationFrame(g),_=setTimeout(x,w),E&&A(a,E,60)}),v))}),{passive:!0})}(r.bindPlacePlay):console.warn("If the click to play configuration is not set, the function of scrolling to the specified lyrics and clicking to play cannot be achieved.")}function P(){!function(t){let r=null;for(let n=0;n<o.length;n++){const a=o[n].target_node;if(n===o.length-1&&a.dataset.time<t){r=o[n];break}if(a.dataset.time<t&&o[n+1].target_node.dataset.time>t){r=o[n];break}}if(r&&c!==r){const t=r.span_arr;c&&(c.target_node.className="",c.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")}))),r.target_node.className="now",t.length<=0&&r.target_node.classList.add("color"),c=r,s&&B(300,c.target_node)}else if(r){const n=r.span_arr;n.length>0&&n.forEach((r=>{r.stm<=t&&0===r.span.classList.length&&(r.span.classList.add("now"),$(r.span,r.duration,100),d=r.span,u=r.duration)}))}}(y.currentTime),l=requestAnimationFrame(P)}function $(t,r,n){let o=null;0!==r?g=requestAnimationFrame((function a(i){o||(o=i);const s=i-o;let l=n*((r-s)/r);l=Math.max(l,0),t.style.setProperty("--progress",`${l}`),s<r&&l>0&&(g=requestAnimationFrame(a))})):t.style.setProperty("--progress","0")}function B(t,r){if(h.forEach((t=>{t.cancel()})),b&&function(){let t=0;o.forEach((r=>{let n=r.target_node,o=n.getBoundingClientRect();o.top>=-.5*f&&o.top<3*f&&(pAn=n.animate([{transform:"translateY(-2.4rem)"}],{easing:"linear",duration:360,fill:"forwards",delay:36*t}),h.push(pAn),t++)}))}(),r.dataset.duration){p.forEach((t=>{t.cancel()}));let t=+r.dataset.duration-1.3;r.querySelectorAll("span").forEach(((r,n)=>{let o=r.animate([{opacity:0}],{easing:"ease",duration:80,fill:"forwards",delay:1e3*t-500*n});p.push(o)}))}A(a,r.offsetTop-f,t)}function A(t,r,n){const o=t.scrollTop,a=performance.now();requestAnimationFrame((function i(s){const l=s-a,c=Math.min(l/n,1);t.scrollTo(0,o+(r-o)*c),c<1&&requestAnimationFrame(i)}))}function F(t){if(Number.isNaN(t))return"00:00";let r=Math.floor(t/60),n=Math.floor(t%60);return r=r>=10?r:`0${r}`,n=n>=10?n:`0${n}`,`${r}:${n}`}function x(t){if(Number.isNaN(t))return;c&&(c.target_node.classList.remove("now"),c.span_arr.forEach((t=>{t.span.className="",t.span.style.setProperty("--progress","100")})));let r=o.reduce(((r,n)=>Math.abs(n.time-t)<Math.abs(r.time-t)&&n.time<t&&!n.target_node.dataset.duration?n:r));r.span_arr.forEach((r=>{r.stm<t&&r.span.classList.add("color")})),y.currentTime=t,r.target_node.classList.add("now");let n=b;b=!1,B(200,r.target_node),n&&(b=!0),c=r}return function(){const t=`p[${v}]:first-child{margin-top:calc(var(--lrcHeight) / 3);}p[${v}]:last-child{margin-bottom:var(--lrcHeight);}.hide-tlyric p[${v}].tly_word{display:none;}p[${v}]{color:var(--baseColor);transition: all .2s;margin:var(--pMargin) 0;padding:0;font-size:var(--fontSize);text-align:var(--textAlign);line-height:var(--lineHeight)}p[${v}] span{padding-right:.5rem;}p[${v}].tly_word{margin:0 !important;font-size: var(--tlyricSize);line-height:var(--tlyricLineHeight)}p[${v}].color{color:var(--hilightColor);}p[${v}] span.circle{display: none;}p[${v}].now span.circle{display: inline-block;width: var(--circleSize);height: var(--circleSize);border-radius: 50%;background-color: var(--baseColor);margin: 0 .4rem;padding: 0 !important;animation: lrc-bounce 500ms infinite alternate;animation-delay: calc(var(--delay) * 1ms);}@keyframes lrc-bounce {to{opacity: .1;transform: translateY(-.5rem) scale(1.2);}}`,n=`p[${v}] span.color{color:var(--hilightColor) !important}p[${v}] span.now {--progress:100;color: transparent;background-clip: text;-webkit-background-clip: text;background-image:linear-gradient(to left, var(--baseColor) calc(var(--progress) * 1%),var(--hilightColor)  0%);}`,o=r.createElement("style");o.textContent=t+n,r.documentElement.querySelector("head").appendChild(o)}(),{init:t=>(C(t),{renderLrc(t){!function(t){o=[],n=[];const{el:a}=i,{lyric_data:s,tlyric_lyric:l,func:c,splitLetter:d}=t;if(!a||!s||!c)throw new Error("The mount el or lyric data or lyric processing func for rendering views cannot be empty.");if(m=d||!1,!(a instanceof Node))throw new Error("el not an element node.");if(a.innerText="",!(c instanceof Function))throw new Error("func not a function.");c(s,l);const u=r.createDocumentFragment();let g=n.length-1;n.forEach(((t,a)=>{let i={},s=[],l=t.current_time;const c=r.createElement("p");if(c.setAttribute(v,""),c.dataset.time=t.current_time,t.word_arr.length>0){let n=t.word_arr[t.word_arr.length-1];l=(n[0][0]+n[0][1])/1e3;const o=r.createDocumentFragment();t.word_arr.forEach((t=>{const n=r.createElement("span");if(m){n.innerHTML=t[1].replace(/\S/g,"<b>$&</b>");let r=0,o=t[0][1];const a=n.querySelectorAll("b");if(a.length>0){o=Math.floor(o/a.length),a[0].style.setProperty("--delay","0ms"),a[0].style.setProperty("--duration",o+"ms");for(let t=1;t<a.length;t++)a[t].style.setProperty("--delay",`${r+=o}ms`),a[t].style.setProperty("--duration",o+"ms")}}else n.innerText=t[1];o.appendChild(n),s.push({span:n,stm:t[0][0]/1e3,duration:t[0][1]})})),c.appendChild(o)}else c.innerText=t.word;if(u.appendChild(c),t.tly_word){const n=r.createElement("p");n.setAttribute(v,""),n.innerText=t.tly_word,n.className="tly_word",i.tlyric_node=n,c.appendChild(n)}i.idx=a,i.target_node=c,i.span_arr=s,i.time=t.current_time,o.push(i);let d=n[Math.min(g,a+1)].current_time-l;if(d>6){const n=r.createElement("p");for(let t=0;t<3;t++){const o=r.createElement("span");o.classList.add("circle"),o.style.setProperty("--delay",180*t),n.appendChild(o)}n.dataset.time=l+1,n.dataset.duration=d.toFixed(2),n.setAttribute(v,""),u.appendChild(n),o.push({target_node:n,span_arr:[],time:t.current_time+1})}})),a.appendChild(u),w(),0!==y.currentTime&&x(y.currentTime)}(t)},addBr(){w()},translation(){a.classList.toggle("hide-tlyric")},doLrcLyric:_,doYrcLyric:E}),toCurrentLyrc(t){x(t)},getMusicTime:t=>F(t),showThumLryc(t,o,a,i){!function(t,o,a,i){if(Number.isNaN(t))return;let s=n.reduce(((r,n)=>Math.abs(n.current_time-t)<Math.abs(r.current_time-t)&&n.current_time<t?n:r)),l=s.idx,c=n.length-1,d=[];if(0===i)d.push({...s,flag:!0});else{let t=new Set,r=new Set;for(let o=0;o<i;o++)l>0&&t.add(n[Math.max(l-i+o,0)]),l>0&&l!==c&&r.add(n[Math.min(l+o+1,c)]);d=[...t,{...s,flag:!0},...r]}const u=r.createDocumentFragment();d.forEach((t=>{const n=r.createElement("p");if(n.innerText=t.word,t.tly_word){const o=r.createElement("p");o.innerText=t.tly_word,o.className="tly_word",n.appendChild(o)}t.flag&&n.classList.add(a),u.appendChild(n)})),o.innerHTML="",o.appendChild(u)}(t,o,a,i)}}}(window,document),MusicBarControl=function(t,r){let n=null,o=0,a=0,i=`data-bar-${Math.random().toString(36).substring(2,8)}`;function s(o){if(!o.oProgress)throw new Error("Not find oProgress properties");if(!(o.oProgress instanceof Node))throw new Error(`${o.oProgress} not a HTML node`);if(!(o.progressBarCallBack instanceof Function))throw new Error(`${o.progressBarCallBack} not a function.`);o._bound=o.oProgress.getBoundingClientRect();const a=r.createElement("div"),s=r.createElement("div"),m=r.createElement("div"),p=r.createElement("div");a.classList.add("progress-under"),a.setAttribute(i,""),s.classList.add("progress-mid"),s.setAttribute(i,""),m.classList.add("progress-top"),m.setAttribute(i,""),p.classList.add("slider"),p.setAttribute(i,""),m.appendChild(p),o.oProgress.setAttribute(i,""),o.oProgress.appendChild(a),o.oProgress.appendChild(s),o.oProgress.appendChild(m),o.initWidth&&(m.style.width=o.initWidth),o._moveing=!1,o.oSlider=p,o.oProgressUnder=a,o.oProgressMid=s,o.oProgressTop=m,(o.el instanceof HTMLAudioElement||o.el instanceof HTMLVideoElement)&&(o.el.addEventListener("loadedmetadata",(function(){o.oTotal.innerText=LrcOrLyrcKit.getMusicTime(o.el.duration),o.oProgressTop.style.width="0%",o.progressBarCallBack&&o.progressBarCallBack(0)})),o._loadBarPlusFunc=l.bind(t,o),o.el.addEventListener("timeupdate",o._loadBarPlusFunc),o.el.addEventListener("progress",(function(){if(o.el.buffered.length>0){const t=o.el.buffered.end(o.el.buffered.length-1)/o.el.duration*100;o.oProgressMid&&(o.oProgressMid.style.width=`${t}%`)}}))),function(o){o._clickProgressFunc=g.bind(t,o),o.oProgress.addEventListener("click",o._clickProgressFunc),o.oSlider.addEventListener("mousedown",d.bind(t,o)),r.addEventListener("mousemove",(function(e){o._moveing&&(n=requestAnimationFrame(c.bind(t,o,e)))})),r.addEventListener("mouseup",u.bind(t,o)),o.oSlider.addEventListener("touchstart",d.bind(t,o),{passive:!0}),r.addEventListener("touchmove",(function(e){o._moveing&&(n=requestAnimationFrame(c.bind(t,o,e.touches[0])))}),{passive:!0}),r.addEventListener("touchend",u.bind(t,o),{passive:!0})}(o)}function l(t){o=t.el.currentTime;const r=t.el.currentTime/t.el.duration*100;t.oProgressTop.style.width=`${r}%`,t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(t.el.currentTime)),t.progressBarCallBack&&t.progressBarCallBack((o/t.el.duration).toFixed(4))}function c(t,e){a=e.clientX-t._bound.left,a<0?a=0:a>t._bound.width&&(a=t._bound.width),t.oProgressTop.style.width=a+"px",t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(o=t.el.duration*(a/t._bound.width),t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(o)),t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&LrcOrLyrcKit.showThumLryc(o,t.oShowLyrc,"highlight",2)}function d(t){t._moveing=!0,_showLyrc&&clearTimeout(_showLyrc),t.oProgressUnder.classList.add("scale"),t.oSlider.classList.add("dragging"),t.oProgress.classList.add("dragging"),t.oProgressMid&&t.oProgressMid.classList.add("scale"),t.oProgressTop.classList.add("scale"),t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&t.el.removeEventListener("timeupdate",t._loadBarPlusFunc),t.oProgress.removeEventListener("click",t._clickProgressFunc),t.oSlider.style.transform="translateY(.1rem) scale(2)",t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.add("show")}function u(t){!Number.isNaN(o)&&t._moveing&&(t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(LrcOrLyrcKit.toCurrentLyrc(o),t.el.addEventListener("timeupdate",t._loadBarPlusFunc)),!t.vibrate||0!==a&&a!==t._bound.width||navigator.vibrate&&navigator.vibrate(t.vibrate),t.progressBarCallBack&&t.progressBarCallBack((a/t._bound.width).toFixed(4))),t.oSlider.classList.remove("dragging"),t.oProgress.classList.remove("dragging"),_showLyrc=setTimeout((function(){t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.remove("show"),t.oSlider.style="",t.oProgressUnder.classList.remove("scale"),t.oProgressMid&&t.oProgressMid.classList.remove("scale"),t.oProgressTop.classList.remove("scale"),t.oProgress.addEventListener("click",t._clickProgressFunc),cancelAnimationFrame(n)}),1e3),t._moveing=!1}function g(r,e){c.call(t,r,e),r.vibrate&&navigator.vibrate&&navigator.vibrate(r.vibrate),r.el&&(r.el instanceof HTMLAudioElement||r.el instanceof HTMLVideoElement)&&LrcOrLyrcKit.toCurrentLyrc(o),r.progressBarCallBack&&r.progressBarCallBack((a/r._bound.width).toFixed(4))}return _showLyrc=0,function(){let t=`.progress-under[${i}],.progress-mid[${i}],.progress-top[${i}]{height:var(--bar-height);border-radius:calc(var(--bar-height) / 2);position:absolute;top:0;left:0;transform:translateY(calc(var(--pg-height) / 2));transition:all .3s}.progress-under.scale[${i}],.progress-mid.scale[${i}],.progress-top.scale[${i}]{height:calc(var(--bar-height) + .2rem);border-radius:calc(var(--bar-height) / 2 + .1rem)}.progress-under[${i}]{width:inherit;background-color:var(--bar-under-bg)}.progress-mid[${i}]{width:0%;background-color:var(--bar-mid-bg)}.progress-top[${i}]{width:0%;background-color:var(--bar-top-bg)}.slider[${i}]{width:var(--slider-size);height:var(--slider-size);border-radius:calc(var(--slider-size) / 2);background-color:var(--slider-bg);position:absolute;right:calc(var(--slider-size) / -2);top:calc(var(--slider-size) / -4);transition:all .3s}.slider[${i}].dragging{cursor:grabbing !important}.progress[${i}].dragging{cursor:grabbing !important}.progress-top[${i}].scale .slider[${i}],.slider[${i}]:hover{transform:scale(1.3);cursor:grab}`;const n=r.createElement("style");n.textContent=t,r.documentElement.querySelector("head").appendChild(n)}(),{init(t){s(t)}}}(window,document);