/**
 * @author: backpackerxl 2025/2/17
 * @description: 这是一个歌词渲染工具&音乐播放器控件控制工具
**/
const LrcOrLyrcKit=function(t,n){let r=[],o=[],i=null,a=null,l=0,s=!0,c=!0,d=null,u=0,m=null,p=0,g=0,h=!0,f=null;function w(t){if(/^\{.*\}$/.test(t)){let n=JSON.parse(t);return`[00:${n.t/1e3}]${n.c[0].tx}${n.c[1].tx}`}return t}function v(t){if(/^\{.*\}$/.test(t)){let n=JSON.parse(t);return`[${n.t},0]${n.c[0].tx}${n.c[1].tx}`}return t}function y(t){let n,r=/\((\d+),(\d+),(\d+)\)([\u4e00-\u9fa5]+|[a-z|’|']+|[.,;:'"]+)/gi,o=[];for(;null!==(n=r.exec(t));){let t=[parseInt(n[1]),parseInt(n[2])],r=n[4];o.push([t,r])}return o}function L(t){let n=t.replace(/^\[/,"").replace(/\]$/,"").split(":");return parseFloat((60*n[0]+parseFloat(n[1])).toFixed(3))}function b(m){a=m,function(){const{el:s,lyric_data:c,tlyric_lyric:d,lineWidth:u,options:m,func:h,splitLetter:f,letterAnimate:w}=a;if(!s||!c||!h)throw new Error("渲染视图的挂载点或歌词数据或歌词处理函数不能为空");const v=u||300,y=f||!1;let L=m||{baseColor:"rgb(233, 235, 235, .5)",poshilightColor:"rgb(233, 235, 235, .5)",hilightColor:"#fff",fontSize:"1.2rem",lineHeight:"1.8rem",tlyricSize:"1rem",tlyricLineHeight:"1.6rem",hilightBgColor:"rgb(204, 204, 204, .2)",filter:"blur(0)",pMargin:"1rem"};if(L.poshilightColor||(L.poshilightColor=L.baseColor),!(s instanceof Node))throw new Error("el不是一个元素节点");if(s.innerText="",!(h instanceof Function))throw new Error("func不是一个可执行函数");h(c,d);const b=n.createDocumentFragment();r.forEach((t=>{let r={},i=[];const a=n.createElement("p");if(a.dataset.time=t.current_time,t.word_arr.length>0){const r=n.createDocumentFragment();t.word_arr.forEach((t=>{const o=n.createElement("span");if(y){o.innerHTML=t[1].replace(/\S/g,"<b>$&</b>");let n=0,r=t[0][1];const i=o.querySelectorAll("b");if(i.length>0){r=Math.floor(r/i.length),i[0].style.setProperty("--delay","0ms"),i[0].style.setProperty("--duration",r+"ms");for(let t=1;t<i.length;t++)i[t].style.setProperty("--delay",`${n+=r}ms`),i[t].style.setProperty("--duration",r+"ms")}}else o.innerText=t[1];r.appendChild(o),i.push({span:o,stm:t[0][0]/1e3,duration:t[0][1]})})),a.appendChild(r)}else a.innerText=t.word;if(b.appendChild(a),t.tly_word){const o=n.createElement("p");o.innerText=t.tly_word,o.className="tly_word",r.tlyric_node=o,a.appendChild(o)}r.target_node=a,r.span_arr=i,r.time=t.current_time,o.push(r)}));const T=s.id;let _=[];if(w){let t=[],n=[],r=[];w.forEach((o=>{_.push(`@keyframes ${T}-${o.animationName}{${o.keyframes}}`),t.push(`${T}-${o.animationName}`),n.push(`${o.animationFillMode}`),r.push(`${o.animationTimingFunction}`)})),_.push(`.custom-animation span.now {color: var(--${T}-baseColor) !important;background-image: none !important;}.custom-animation span.now b {display: inline-block;animation-duration: var(--duration);animation-fill-mode: ${n.join(",")};animation-timing-function: ${r.join(",")};animation-name: ${t.join(",")};animation-delay: var(--delay);}`)}const $=n.createElement("style");$.textContent=function(t,n){const{baseColor:r,poshilightColor:o,hilightColor:i,fontSize:a,lineHeight:l,tlyricSize:s,tlyricLineHeight:c,filter:d,pMargin:u}=t;return`:root{--${n}-pMargin:${u};--${n}-filter:${d};--${n}-poshilightColor:${o};--${n}-baseColor:${r};--${n}-fontSize:${a};--${n}-hilightColor:${i};--${n}-lineHeight:${l};--${n}-tlyricSize:${s};--${n}-tlyricLineHeight:${c};}.hide-tlyric p.tly_word{display:none;}#${n} p.now,#${n} p.now .tly_word{transform: scale(1.05);filter:blur(0);transition: transform .3s ease-in-out; color:var(--${n}-poshilightColor);}#${n} p{color:var(--${n}-baseColor);filter:blur(var(--${n}-filter));margin:var(--${n}-pMargin) 0;padding:0;font-size:var(--${n}-fontSize);text-align:center;line-height:var(--${n}-lineHeight)}#${n} p span{padding-right:6px;}#${n} p.tly_word{margin:0 !important;font-size: var(--${n}-tlyricSize);line-height: var(--${n}-tlyricLineHeight);}#${n} p.color{color:var(--${n}-hilightColor);transition:all.1s ease-in-out}#${n} p span.now{color:transparent;background-image:linear-gradient(to left,var(--${n}-poshilightColor) calc(100% - calc(var(--${n}-progress) * 100%)),var(--${n}-hilightColor) calc(100% - calc(var(--${n}-progress) * 100%)));background-clip:text;-webkit-background-clip:text;transition: all .5s;}`}(L,T)+_.join(""),n.documentElement.querySelector("head").appendChild($),s.appendChild(b),o.forEach((t=>{t.span_arr.forEach((t=>{t.offsetWidth=t.span.offsetWidth}))}));for(let t of o){const r=t.target_node;t.span_arr.reduce(((t,o)=>{let i=t+o.offsetWidth;return i>v&&(r.insertBefore(n.createElement("br"),o.span),i=0),i}),0)}l=2*Number(t.getComputedStyle(o[0].target_node).marginBottom.replace("px","")),g=s.getBoundingClientRect().height/2,p=1*window.getComputedStyle(o[0].target_node).getPropertyValue("margin-top").replace("px",""),i=s}(),m.bindAudio&&function(t){if(!t.el)throw new Error("el不存在");if(!(t.el instanceof HTMLAudioElement))throw new Error("el不是一个html Audio播放器");let n;f=t.el,f.addEventListener("pause",(function(){cancelAnimationFrame(d)})),f.addEventListener("play",(function(){s=!0,n&&clearTimeout(n),T(),n=setTimeout((()=>{s=!1}),600)}))}({el:m.bindAudio}),m.bindPlacePlay&&function(t){let n=null,r=null,a=null,s=null,d=null;const m=t.pcTimer||1200,g=t.mbTimer||800,h=t.timeTagTimer||6e3;t.startMoveCallBack&&t.startMoveCallBack instanceof Function&&(n=t.startMoveCallBack.bind(t));t.onMoveCallBack&&t.onMoveCallBack instanceof Function&&(r=t.onMoveCallBack.bind(t));t.stopMoveCallBack&&t.stopMoveCallBack instanceof Function&&(a=t.stopMoveCallBack.bind(t));t.unMoveCallBack&&t.unMoveCallBack instanceof Function&&(d=t.unMoveCallBack.bind(t));t.clickCallBack&&t.clickCallBack instanceof Function&&(s=t.clickCallBack.bind(t));let w,v,y,L,b=null;t.getMusicTime=C;let T=t.startPlay;T&&T.addEventListener("click",(function(){b.span_arr.forEach((t=>{t.span.className="",t.span.style=""})),f.currentTime=b.target_node.dataset.time,cancelAnimationFrame(L),d&&d(),s&&s(),u=i.scrollTop+p,c=!0}));const _=T.getBoundingClientRect(),$=_.top,M=_.bottom;function P(){let n,a;function s(){for(const t of o){const r=t.target_node.getBoundingClientRect();if(r.top>$&&r.bottom-r.height<M){n=t,a=r.height+l,y=i.scrollTop+r.top-$+r.height/2-a/2;break}}n&&n!==b&&(b=n,t.nowLine=n,t.targetRectHeight=a,r&&r()),L=requestAnimationFrame(s)}c=!1,L=requestAnimationFrame(s)}function B(){cancelAnimationFrame(L),d&&d(),c=!0}i.addEventListener("wheel",(()=>{n&&n(),P(),w&&clearTimeout(w),v&&clearTimeout(v),w=setTimeout((()=>{a&&a(),v=setTimeout(B,h),y&&E(i,y,60)}),m)}),{passive:!0});let k=0,F=0;i.addEventListener("touchstart",(e=>{k=e.touches[0].clientY}),{passive:!0}),i.addEventListener("touchmove",(e=>{F=Math.abs(e.touches[0].clientY-k)}),{passive:!0}),i.addEventListener("touchend",(()=>{F>0&&(n&&n(),P(),w&&clearTimeout(w),v&&clearTimeout(v),w=setTimeout((()=>{F=0,a&&a(),v=setTimeout(B,h),y&&E(i,y,60)}),g))}),{passive:!0})}(m.bindPlacePlay)}function T(){m=function(t,n){let r=null;for(let n=0;n<o.length;n++){const i=o[n].target_node;if(n===o.length-1&&i.dataset.time<t){r=o[n];break}if(i.dataset.time<t&&o[n+1].target_node.dataset.time>t){r=o[n];break}}if(r&&n!==r){const t=r.span_arr;n&&(n.target_node.className="",n.span_arr.forEach((t=>{t.span.className="",t.span.style=""}))),r.target_node.className="now",t.length<=0&&r.target_node.classList.add("color"),n=r,c&&$(300,n.target_node)}else if(r){const n=r.span_arr;n.length>0&&n.forEach((n=>{n.stm<=t&&0===n.span.classList.length&&(n.span.classList.add("now"),h&&_(n.span,s?0:n.duration))}))}return n}(f.currentTime,m),d=requestAnimationFrame(T)}function _(t,n){let r=0;const o=n/16.67;let a=0;requestAnimationFrame((function n(){a<o?(r=Math.floor(a/o*100),t.style.setProperty(`--${i.id}-progress`,.01*r),a++,requestAnimationFrame(n)):t.style.setProperty(`--${i.id}-progress`,1)}))}function $(t,n){const r=n.getBoundingClientRect();u+=r.top-g+r.height,E(i,u,t)}function E(t,n,r){const o=t.scrollTop,i=performance.now();requestAnimationFrame((function a(l){const s=l-i,c=Math.min(s/r,1);t.scrollTo(0,o+(n-o)*c),c<1&&requestAnimationFrame(a)}))}function C(t){if(Number.isNaN(t))return"00:00";let n=Math.floor(t/60),r=Math.floor(t%60);return n=n>=10?n:`0${n}`,r=r>=10?r:`0${r}`,`${n}:${r}`}return{init(t){b(t)},translation(){i.classList.toggle("hide-tlyric")},toCurrentLyrc(t){!function(t){if(Number.isNaN(t))return;m&&(m.target_node.classList.remove("now"),m.span_arr.forEach((t=>{t.span.className="",t.span.style=""})));let n=o.reduce(((n,r)=>Math.abs(r.time-t)<Math.abs(n.time-t)&&r.time<t?r:n));n.span_arr.forEach((n=>{n.stm<t&&h&&(n.span.classList.add("now"),n.span.style.setProperty(`--${i.id}-progress`,1))})),f.currentTime=t,n.target_node.classList.add("now"),$(350,n.target_node),m=n}(t)},getMusicTime:t=>C(t),changeAnimation(){a.splitLetter,i.classList.toggle("custom-animation"),h=!h},showThumLryc(t,o,i){!function(t,o,i){if(Number.isNaN(t))return;let a=r.reduce(((n,r)=>Math.abs(r.current_time-t)<Math.abs(n.current_time-t)&&r.current_time<t?r:n)),l=a.idx,s=r.length-1,c=[r[Math.max(0,l-2)],r[Math.max(0,l-1)],{...a,flag:!0},r[Math.min(s,l+1)],r[Math.min(s,l+2)]];c=[...new Set(c)];const d=n.createDocumentFragment();c.forEach((t=>{const r=n.createElement("p");if(r.innerText=t.word,t.tly_word){const o=n.createElement("p");o.innerText=t.tly_word,o.className="tly_word",r.appendChild(o)}t.flag&&r.classList.add(i),d.appendChild(r)})),o.innerHTML="",o.appendChild(d)}(t,o,i)},doLrcLyric:function(t,n){let o=t.split("\n"),i=[];n&&(i=n.split("\n"));const a=/\[.+?\]/;o=o.map((t=>{const n=(t=w(t)).match(a);return n?{current_time:L(n[0]),word:t.replace(a,"").trim(),word_arr:[]}:null})).filter((t=>null!==t));const l=new Map;i.forEach((t=>{const n=(t=w(t)).match(a);return n&&l.set(L(n[0]),t.replace(a,"").trim()),null})),o.forEach(((t,n)=>{""!==t.word&&r.push({...t,tly_word:l.get(t.current_time)||null,idx:n})}))},doYrcLyric:function(t,n){let o=t.split("\n"),i=[];n&&(i=n.split("\n"));const a=/\[.+?\]/;o=o.map((t=>{const n=(t=v(t)).match(a);if(n){return{current_time:n[0].replace(/^\[/,"").replace(/\]$/,"").split(",")[0]/1e3,word:t.replace(a,"").replaceAll(/\(.+?\)/g,"").trim(),word_arr:y(t)}}return null})).filter((t=>null!==t));const l=new Map;i.forEach((t=>{const n=(t=v(t)).match(a);return n&&l.set(L(n[0]),t.replace(a,"").trim()),null})),o.forEach(((t,n)=>{r.push({...t,tly_word:l.get(t.current_time)||null,idx:n})}))},lrcNodeArr:o,songWord:r}}(window,document),MusicControl=function(t,n){let r=null,o=0,i=0,a=0;function l(o){if(!(o.oProgressTop&&o.oSlider&&o.oProgress&&o.oProgressUnder))throw new Error("oProgressTop: 进度条或 oSlider:拖动滑块或 oProgress:总滑动条或 oProgressUnder:进度条轨道不能为空");if(!(o.oProgressTop instanceof Node&&o.oSlider instanceof Node&&o.oProgress instanceof Node&&o.oProgressUnder instanceof Node))throw new Error("oProgressTop: 进度条或 oSlider:拖动滑块或 oProgress:总滑动条或 oProgressUnder:进度条轨道必须是dom元素");if(!(o.progressBarCallBack instanceof Function))throw new Error(`progressBarCallBack: ${o.progressBarCallBack}不是个函数`);o._bound=o.oProgress.getBoundingClientRect(),o._moveing=!1,(o.el instanceof HTMLAudioElement||o.el instanceof HTMLVideoElement)&&(o.el.addEventListener("loadedmetadata",(function(){o.oTotal.innerText=LrcOrLyrcKit.getMusicTime(o.el.duration),o.oProgressTop.style.width="0%",o.progressBarCallBack&&o.progressBarCallBack(0)})),o._loadBarPlusFunc=s.bind(t,o),o.el.addEventListener("timeupdate",o._loadBarPlusFunc),o.el.addEventListener("progress",(function(){if(o.el.buffered.length>0){const t=o.el.buffered.end(o.el.buffered.length-1)/o.el.duration*100;o.oProgressMid&&(o.oProgressMid.style.width=`${t}%`)}}))),function(o){o._clickProgressFunc=m.bind(t,o),o.oProgress.addEventListener("click",o._clickProgressFunc),o.oSlider.addEventListener("mousedown",d.bind(t,o)),n.addEventListener("mousemove",(function(e){o._moveing&&(r=requestAnimationFrame(c.bind(t,o,e)))})),n.addEventListener("mouseup",u.bind(t,o)),o.oSlider.addEventListener("touchstart",d.bind(t,o),{passive:!0}),n.addEventListener("touchmove",(function(e){o._moveing&&(r=requestAnimationFrame(c.bind(t,o,e.touches[0])))}),{passive:!0}),n.addEventListener("touchend",u.bind(t,o),{passive:!0})}(o)}function s(t){o=t.el.currentTime;const n=t.el.currentTime/t.el.duration*100;t.oProgressTop.style.width=`${n}%`,t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(t.el.currentTime)),t.progressBarCallBack&&t.progressBarCallBack((o/t.el.duration).toFixed(4))}function c(t,e){i=e.clientX-t._bound.left,i<0?i=0:i>t._bound.width&&(i=t._bound.width),t.oProgressTop.style.width=i+"px",t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(o=t.el.duration*(i/t._bound.width),t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(o)),t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&LrcOrLyrcKit.showThumLryc(o,t.oShowLyrc,"highlight")}function d(t){t._moveing=!0,a&&clearTimeout(a),t.oProgressUnder.classList.add("scale"),t.oProgressMid&&t.oProgressMid.classList.add("scale"),t.oProgressTop.classList.add("scale"),t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&t.el.removeEventListener("timeupdate",t._loadBarPlusFunc),t.oProgress.removeEventListener("click",t._clickProgressFunc),t.oSlider.style.transform="translateY(.1rem) scale(2)",t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.add("show")}function u(t){!Number.isNaN(o)&&t._moveing&&(t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(LrcOrLyrcKit.toCurrentLyrc(o),t.el.addEventListener("timeupdate",t._loadBarPlusFunc)),!t.vibrate||0!==i&&i!==t._bound.width||navigator.vibrate&&navigator.vibrate(t.vibrate),t.progressBarCallBack&&t.progressBarCallBack((i/t._bound.width).toFixed(4))),a=setTimeout((function(){t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.remove("show"),t.oSlider.style="",t.oProgressUnder.classList.remove("scale"),t.oProgressMid&&t.oProgressMid.classList.remove("scale"),t.oProgressTop.classList.remove("scale"),t.oProgress.addEventListener("click",t._clickProgressFunc),cancelAnimationFrame(r)}),1e3),t._moveing=!1}function m(n,e){c.call(t,n,e),n.vibrate&&navigator.vibrate&&navigator.vibrate(n.vibrate),n.el&&(n.el instanceof HTMLAudioElement||n.el instanceof HTMLVideoElement)&&LrcOrLyrcKit.toCurrentLyrc(o),n.progressBarCallBack&&n.progressBarCallBack((i/n._bound.width).toFixed(4))}return{init(t){l(t)}}}(window,document);