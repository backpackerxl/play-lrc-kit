/**
 * @author: backpackerxl 2025/2/17
 * @description: 这是一个歌词渲染工具&音乐播放器控件控制工具
**/
const LrcOrLyrcKit=function(t,n){let o=[],r=[],i=null,a=null,l=0,s=!0,c=!0,d=null,u=0,m=null,p=0,g=0,h=!0,f=null;function w(t){if(/^\{.*\}$/.test(t)){let n=JSON.parse(t);return`[00:${n.t/1e3}]${n.c[0].tx}${n.c[1].tx}`}return t}function y(t){if(/^\{.*\}$/.test(t)){let n=JSON.parse(t);return`[${n.t},0]${n.c[0].tx}${n.c[1].tx}`}return t}function L(t){let n,o=/\((\d+),(\d+),(\d+)\)([\u4e00-\u9fa5]+|[a-z|’|']+|[.,;:'"]+)/gi,r=[];for(;null!==(n=o.exec(t));){let t=[parseInt(n[1]),parseInt(n[2])],o=n[4];r.push([t,o])}return r}function T(t){let n=t.replace(/^\[/,"").replace(/\]$/,"").split(":");return parseFloat((60*n[0]+parseFloat(n[1])).toFixed(3))}function v(m){a=m,function(){const{el:s,lyric_data:c,tlyric_lyric:d,lineWidth:u,options:m,func:h,splitLetter:f,letterAnimate:w}=a;if(!s||!c||!h)throw new Error("渲染视图的挂载点或歌词数据或歌词处理函数不能为空");const y=u||300,L=f||!1;let T=m||{baseColor:"rgb(233, 235, 235, .5)",poshilightColor:"rgb(233, 235, 235, .5)",hilightColor:"#fff",fontSize:"1.2rem",lineHeight:"1.8rem",tlyricSize:"1rem",tlyricLineHeight:"1.6rem",hilightBgColor:"rgb(204, 204, 204, .2)",filter:"blur(0)",pMargin:"1rem"};if(T.poshilightColor||(T.poshilightColor=T.baseColor),!(s instanceof Node))throw new Error("el不是一个元素节点");if(s.innerText="",!(h instanceof Function))throw new Error("func不是一个可执行函数");h(c,d);const v=n.createDocumentFragment();o.forEach((t=>{let o={},i=[];const a=n.createElement("p");if(a.dataset.time=t.current_time,t.word_arr.length>0){const o=n.createDocumentFragment();t.word_arr.forEach((t=>{const r=n.createElement("span");if(L){r.innerHTML=t[1].replace(/\S/g,"<b>$&</b>");let n=0,o=t[0][1];const i=r.querySelectorAll("b");if(i.length>0){o=Math.floor(o/i.length),i[0].style.setProperty("--delay","0ms"),i[0].style.setProperty("--duration",o+"ms");for(let t=1;t<i.length;t++)i[t].style.setProperty("--delay",`${n+=o}ms`),i[t].style.setProperty("--duration",o+"ms")}}else r.innerText=t[1];o.appendChild(r),i.push({span:r,stm:t[0][0]/1e3,duration:t[0][1]})})),a.appendChild(o)}else a.innerText=t.word;if(v.appendChild(a),t.tly_word){const r=n.createElement("p");r.innerText=t.tly_word,r.className="tly_word",o.tlyric_node=r,a.appendChild(r)}o.target_node=a,o.span_arr=i,o.time=t.current_time,r.push(o)}));const _=s.id;let $=[];if(w){let t=[],n=[],o=[];w.forEach((r=>{$.push(`@keyframes ${_}-${r.animationName}{${r.keyframes}}`),t.push(`${_}-${r.animationName}`),n.push(`${r.animationFillMode}`),o.push(`${r.animationTimingFunction}`)})),$.push(`.custom-animation span.now {color: var(--${_}-baseColor) !important;background-image: none !important;}.custom-animation span.now b {display: inline-block;animation-duration: var(--duration);animation-fill-mode: ${n.join(",")};animation-timing-function: ${o.join(",")};animation-name: ${t.join(",")};animation-delay: var(--delay);}`)}const E=n.createElement("style");E.textContent=function(t,n){const{baseColor:o,poshilightColor:r,hilightColor:i,fontSize:a,lineHeight:l,tlyricSize:s,tlyricLineHeight:c,filter:d,pMargin:u}=t;return`:root{--${n}-pMargin:${u};--${n}-filter:${d};--${n}-poshilightColor:${r};--${n}-baseColor:${o};--${n}-fontSize:${a};--${n}-hilightColor:${i};--${n}-lineHeight:${l};--${n}-tlyricSize:${s};--${n}-tlyricLineHeight:${c};}.hide-tlyric p.tly_word{display:none;}#${n} p.now,#${n} p.now .tly_word{transform: scale(1.05);filter:blur(0);transition: transform .3s ease-in-out; color:var(--${n}-poshilightColor);}#${n} p{color:var(--${n}-baseColor);filter:blur(var(--${n}-filter));margin:var(--${n}-pMargin) 0;padding:0;font-size:var(--${n}-fontSize);text-align:center;line-height:var(--${n}-lineHeight)}#${n} p span{padding-right:6px;}#${n} p.tly_word{margin:0 !important;font-size: var(--${n}-tlyricSize);line-height: var(--${n}-tlyricLineHeight);}#${n} p.color{color:var(--${n}-hilightColor);transition:all.1s ease-in-out}#${n} p span.now{color:transparent;background-image:linear-gradient(to left,var(--${n}-poshilightColor) calc(100% - calc(var(--${n}-progress) * 100%)),var(--${n}-hilightColor) calc(100% - calc(var(--${n}-progress) * 100%)));background-clip:text;-webkit-background-clip:text;transition: all .5s;}`}(T,_)+$.join(""),n.documentElement.querySelector("head").appendChild(E),s.appendChild(v),r.forEach((t=>{t.span_arr.forEach((t=>{t.offsetWidth=t.span.offsetWidth}))}));for(let t of r){const o=t.target_node;t.span_arr.reduce(((t,r)=>{let i=t+r.offsetWidth;return i>y&&(o.insertBefore(n.createElement("br"),r.span),i=0),i}),0)}l=2*Number(t.getComputedStyle(r[0].target_node).marginBottom.replace("px","")),g=s.getBoundingClientRect().height/2,p=1*window.getComputedStyle(r[0].target_node).getPropertyValue("margin-top").replace("px",""),i=s}(),m.bindAudio&&function(t){if(!t.el)throw new Error("el不存在");if(!(t.el instanceof HTMLAudioElement))throw new Error("el不是一个html Audio播放器");let n;f=t.el,f.addEventListener("pause",(function(){cancelAnimationFrame(d)})),f.addEventListener("play",(function(){s=!0,n&&clearTimeout(n),_(),n=setTimeout((()=>{s=!1}),600)}))}({el:m.bindAudio}),m.bindPlacePlay&&function(t){let n=null,o=null,a=null,s=null,d=null;const m=t.pcTimer||1200,g=t.mbTimer||800,h=t.timeTagTimer||6e3;t.startMoveCallBack&&t.startMoveCallBack instanceof Function&&(n=t.startMoveCallBack.bind(t));t.onMoveCallBack&&t.onMoveCallBack instanceof Function&&(o=t.onMoveCallBack.bind(t));t.stopMoveCallBack&&t.stopMoveCallBack instanceof Function&&(a=t.stopMoveCallBack.bind(t));t.unMoveCallBack&&t.unMoveCallBack instanceof Function&&(d=t.unMoveCallBack.bind(t));t.clickCallBack&&t.clickCallBack instanceof Function&&(s=t.clickCallBack.bind(t));let w,y,L,T,v=null;t.getMusicTime=C;let _=t.startPlay;_&&_.addEventListener("click",(function(){v.span_arr.forEach((t=>{t.span.className="",t.span.style=""})),f.currentTime=v.target_node.dataset.time,cancelAnimationFrame(T),d&&d(),s&&s(),u=i.scrollTop+p,c=!0}));const $=_.getBoundingClientRect(),E=$.top,M=$.bottom;function P(){let n,a;function s(){for(const t of r){const o=t.target_node.getBoundingClientRect();if(o.top>E&&o.bottom-o.height<M){n=t,a=o.height+l,L=i.scrollTop+o.top-E+o.height/2-a/2;break}}n&&n!==v&&(v=n,t.nowLine=n,t.targetRectHeight=a,o&&o()),T=requestAnimationFrame(s)}c=!1,T=requestAnimationFrame(s)}function B(){cancelAnimationFrame(T),d&&d(),c=!0}i.addEventListener("wheel",(()=>{n&&n(),P(),w&&clearTimeout(w),y&&clearTimeout(y),w=setTimeout((()=>{a&&a(),y=setTimeout(B,h),L&&b(i,L,60)}),m)}),{passive:!0});let k=0,F=0;i.addEventListener("touchstart",(e=>{k=e.touches[0].clientY}),{passive:!0}),i.addEventListener("touchmove",(e=>{F=Math.abs(e.touches[0].clientY-k)}),{passive:!0}),i.addEventListener("touchend",(()=>{F>0&&(n&&n(),P(),w&&clearTimeout(w),y&&clearTimeout(y),w=setTimeout((()=>{F=0,a&&a(),y=setTimeout(B,h),L&&b(i,L,60)}),g))}),{passive:!0})}(m.bindPlacePlay)}function _(){m=function(t,n){let o=null;for(let n=0;n<r.length;n++){const i=r[n].target_node;if(n===r.length-1&&i.dataset.time<t){o=r[n];break}if(i.dataset.time<t&&r[n+1].target_node.dataset.time>t){o=r[n];break}}if(o&&n!==o){const t=o.span_arr;n&&(n.target_node.className="",n.span_arr.forEach((t=>{t.span.className="",t.span.style=""}))),o.target_node.className="now",t.length<=0&&o.target_node.classList.add("color"),n=o,c&&E(300,n.target_node)}else if(o){const n=o.span_arr;n.length>0&&n.forEach((n=>{n.stm<=t&&0===n.span.classList.length&&(n.span.classList.add("now"),h&&$(n.span,s?0:n.duration))}))}return n}(f.currentTime,m),d=requestAnimationFrame(_)}function $(t,n){let o=0;const r=n/16.67;let a=0;requestAnimationFrame((function n(){a<r?(o=Math.floor(a/r*100),t.style.setProperty(`--${i.id}-progress`,.01*o),a++,requestAnimationFrame(n)):t.style.setProperty(`--${i.id}-progress`,1)}))}function E(t,n){const o=n.getBoundingClientRect();u+=o.top-g+o.height,b(i,u,t)}function b(t,n,o){const r=t.scrollTop,i=performance.now();requestAnimationFrame((function a(l){const s=l-i,c=Math.min(s/o,1);t.scrollTo(0,r+(n-r)*c),c<1&&requestAnimationFrame(a)}))}function C(t){if(Number.isNaN(t))return"00:00";let n=Math.floor(t/60),o=Math.floor(t%60);return n=n>=10?n:`0${n}`,o=o>=10?o:`0${o}`,`${n}:${o}`}return{init(t){v(t)},translation(){i.classList.toggle("hide-tlyric")},toCurrentLyrc(t){!function(t){if(Number.isNaN(t))return;m&&(m.target_node.classList.remove("now"),m.span_arr.forEach((t=>{t.span.className="",t.span.style=""})));let n=r.reduce(((n,o)=>Math.abs(o.time-t)<Math.abs(n.time-t)&&o.time<t?o:n));n.span_arr.forEach((n=>{n.stm<t&&h&&(n.span.classList.add("now"),n.span.style.setProperty(`--${i.id}-progress`,1))})),f.currentTime=t,n.target_node.classList.add("now"),E(350,n.target_node),m=n}(t)},getMusicTime:t=>C(t),changeAnimation(){a.splitLetter,i.classList.toggle("custom-animation"),h=!h},showThumLryc(t,r,i){!function(t,r,i){if(Number.isNaN(t))return;let a=o.reduce(((n,o)=>Math.abs(o.current_time-t)<Math.abs(n.current_time-t)&&o.current_time<t?o:n)),l=a.idx,s=o.length-1,c=[o[Math.max(0,l-2)],o[Math.max(0,l-1)],{...a,flag:!0},o[Math.min(s,l+1)],o[Math.min(s,l+2)]];c=[...new Set(c)];const d=n.createDocumentFragment();c.forEach((t=>{const o=n.createElement("p");if(o.innerText=t.word,t.tly_word){const r=n.createElement("p");r.innerText=t.tly_word,r.className="tly_word",o.appendChild(r)}t.flag&&o.classList.add(i),d.appendChild(o)})),r.innerHTML="",r.appendChild(d)}(t,r,i)},doLrcLyric:function(t,n){let r=t.split("\n"),i=[];n&&(i=n.split("\n"));const a=/\[.+?\]/;r=r.map((t=>{const n=(t=w(t)).match(a);return n?{current_time:T(n[0]),word:t.replace(a,"").trim(),word_arr:[]}:null})).filter((t=>null!==t));const l=new Map;i.forEach((t=>{const n=(t=w(t)).match(a);return n&&l.set(T(n[0]),t.replace(a,"").trim()),null})),r.forEach(((t,n)=>{""!==t.word&&o.push({...t,tly_word:l.get(t.current_time)||null,idx:n})}))},doYrcLyric:function(t,n){let r=t.split("\n"),i=[];n&&(i=n.split("\n"));const a=/\[.+?\]/;r=r.map((t=>{const n=(t=y(t)).match(a);if(n){return{current_time:n[0].replace(/^\[/,"").replace(/\]$/,"").split(",")[0]/1e3,word:t.replace(a,"").replaceAll(/\(.+?\)/g,"").trim(),word_arr:L(t)}}return null})).filter((t=>null!==t));const l=new Map;i.forEach((t=>{const n=(t=y(t)).match(a);return n&&l.set(T(n[0]),t.replace(a,"").trim()),null})),r.forEach(((t,n)=>{o.push({...t,tly_word:l.get(t.current_time)||null,idx:n})}))},lrcNodeArr:r,songWord:o}}(window,document),MusicControl=function(t,n){let o=null,r=0,i=0,a=0;function l(r){if(!(r.oProgressTop&&r.oSlider&&r.oProgress&&r.oProgressUnder))throw new Error("oProgressTop: 进度条或 oSlider:拖动滑块或 oProgress:总滑动条或 oProgressUnder:进度条轨道不能为空");if(!(r.oProgressTop instanceof Node&&r.oSlider instanceof Node&&r.oProgress instanceof Node&&r.oProgressUnder instanceof Node))throw new Error("oProgressTop: 进度条或 oSlider:拖动滑块或 oProgress:总滑动条或 oProgressUnder:进度条轨道必须是dom元素");if(!(r.progressBarCallBack instanceof Function))throw new Error(`progressBarCallBack: ${r.progressBarCallBack}不是个函数`);r._bound=r.oProgress.getBoundingClientRect(),r._moveing=!1,(r.el instanceof HTMLAudioElement||r.el instanceof HTMLVideoElement)&&(r.el.addEventListener("loadedmetadata",(function(){r.oTotal.innerText=LrcOrLyrcKit.getMusicTime(r.el.duration),r.oProgressTop.style.width="0%",r.progressBarCallBack&&r.progressBarCallBack(0)})),r._loadBarPlusFunc=s.bind(t,r),r.el.addEventListener("timeupdate",r._loadBarPlusFunc),r.el.addEventListener("progress",(function(){if(r.el.buffered.length>0){const t=r.el.buffered.end(r.el.buffered.length-1)/r.el.duration*100;r.oProgressMid&&(r.oProgressMid.style.width=`${t}%`)}}))),function(r){r._clickProgressFunc=m.bind(t,r),r.oProgress.addEventListener("click",r._clickProgressFunc),r.oSlider.addEventListener("mousedown",d.bind(t,r)),n.addEventListener("mousemove",(function(e){r._moveing&&(o=requestAnimationFrame(c.bind(t,r,e)))})),n.addEventListener("mouseup",u.bind(t,r)),r.oSlider.addEventListener("touchstart",d.bind(t,r),{passive:!0}),n.addEventListener("touchmove",(function(e){r._moveing&&(o=requestAnimationFrame(c.bind(t,r,e.touches[0])))}),{passive:!0}),n.addEventListener("touchend",u.bind(t,r),{passive:!0})}(r)}function s(t){r=t.el.currentTime;const n=t.el.currentTime/t.el.duration*100;t.oProgressTop.style.width=`${n}%`,t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(t.el.currentTime)),t.progressBarCallBack&&t.progressBarCallBack((r/t.el.duration).toFixed(4))}function c(t,e){i=e.clientX-t._bound.left,i<0?i=0:i>t._bound.width&&(i=t._bound.width),t.oProgressTop.style.width=i+"px",t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(r=t.el.duration*(i/t._bound.width),t.oNowTime.innerText=LrcOrLyrcKit.getMusicTime(r)),t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&LrcOrLyrcKit.showThumLryc(r,t.oShowLyrc,"highlight")}function d(t){t._moveing=!0,a&&clearTimeout(a),t.oProgressUnder.classList.add("scale"),t.oProgressMid&&t.oProgressMid.classList.add("scale"),t.oProgressTop.classList.add("scale"),t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&t.el.removeEventListener("timeupdate",t._loadBarPlusFunc),t.oProgress.removeEventListener("click",t._clickProgressFunc),t.oSlider.style.transform="translateY(.1rem) scale(2)",t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.add("show")}function u(t){!Number.isNaN(r)&&t._moveing&&(t.el&&(t.el instanceof HTMLAudioElement||t.el instanceof HTMLVideoElement)&&(LrcOrLyrcKit.toCurrentLyrc(r),t.el.addEventListener("timeupdate",t._loadBarPlusFunc)),t.progressBarCallBack&&t.progressBarCallBack((i/t._bound.width).toFixed(4))),a=setTimeout((function(){t.oShowLyrc&&t.oShowLyrc instanceof HTMLElement&&t.oShowLyrc.classList.remove("show"),t.oSlider.style="",t.oProgressUnder.classList.remove("scale"),t.oProgressMid&&t.oProgressMid.classList.remove("scale"),t.oProgressTop.classList.remove("scale"),t.oProgress.addEventListener("click",t._clickProgressFunc),cancelAnimationFrame(o)}),1e3),t._moveing=!1}function m(n,e){c.call(t,n,e),n.el&&(n.el instanceof HTMLAudioElement||n.el instanceof HTMLVideoElement)&&LrcOrLyrcKit.toCurrentLyrc(r),n.progressBarCallBack&&n.progressBarCallBack((i/n._bound.width).toFixed(4))}return{init(t){l(t)}}}(window,document);